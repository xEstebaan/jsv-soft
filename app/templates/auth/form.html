{% extends "base.html" %} {% block title %}{% if form_type == 'login' %}Iniciar
sesión{% else %}Crear cuenta{% endif %}{% endblock %} {% block header_buttons %}
<a href="{{ url_for('index') }}" class="nav-button">Inicio</a>
{% if form_type == 'login' %}
<a href="{{ url_for('auth.register') }}" class="nav-button nav-button--primary"
  >¿Eres visitante?</a
>
{% else %}
<a href="{{ url_for('auth.login') }}" class="nav-button">Iniciar Sesión</a>
{% endif %} {% endblock %} {% block stylesheets %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/auth.css') }}"
/>
{% endblock %} {% block content %}

<div class="auth-container">
  <div class="auth-card">
    <div class="auth-header">
      <img
        src="{{ url_for('static', filename='img/logo.png') }}"
        alt="JSV Soft"
      />
      <p class="auth-subtitle">
        {% if form_type == 'login' %}Inicia sesión para acceder a tu panel{%
        else %}Crea tu cuenta para comenzar{% endif %}
      </p>
    </div>

    <form method="post">
      {{ form.hidden_tag() }} {% if form_type == 'register' %}
      <div class="form-group">
        <label>Primer nombre <span class="required-asterisk">*</span></label>
        {{ form.primer_nombre() }}
      </div>
      <div class="form-group">
        <label>Segundo nombre</label>
        {{ form.segundo_nombre() }}
      </div>
      <div class="form-group">
        <label>Primer apellido <span class="required-asterisk">*</span></label>
        {{ form.primer_apellido() }}
      </div>
      <div class="form-group">
        <label>Segundo apellido</label>
        {{ form.segundo_apellido() }}
      </div>
      <div class="form-group">
        <label>Documento <span class="required-asterisk">*</span></label>
        {{ form.documento() }}
      </div>
      <div class="form-group">
        <label>Celular</label>
        {{ form.celular() }}
      </div>
      {% endif %}

      <div class="form-group">
        <label>Correo <span class="required-asterisk">*</span></label>
        {{ form.correo(size=32) }}
      </div>
      <div class="form-group">
        <label>Contraseña <span class="required-asterisk">*</span></label>
        {{ form.contrasena() }}
      </div>

      {% if form_type == 'login' %}
      <div class="form-group">{{ form.recordar() }} Recuérdame</div>
      {% else %}
      <div class="form-group">
        <label
          >Confirmar contraseña <span class="required-asterisk">*</span></label
        >
        {{ form.confirmar_contrasena() }}
      </div>
      {% endif %}

      <div class="auth-actions">
        <button type="submit" class="btn-primary">
          {% if form_type == 'login' %}Iniciar sesión{% else %}Crear cuenta{%
          endif %}
        </button>
      </div>
    </form>

    <p class="helper">
      {% if form_type == 'login' %} ¿Eres visitante?
      <a href="{{ url_for('auth.register') }}">Crear cuenta</a> {% else %} ¿Ya
      tienes cuenta? <a href="{{ url_for('auth.login') }}">Inicia sesión</a>
      {% endif %}
    </p>
  </div>
</div>

<!-- Modal para mostrar PIN generado -->
<div id="pinModal" class="modal" style="display: none">
  <div class="modal-content">
    <div class="modal-header">
      <h2>¡Usuario creado correctamente!</h2>
    </div>
    <div class="modal-body">
      <p class="modal-message">
        Se asignó un PIN de acceso. Guárdalo en un lugar seguro:
      </p>
      <div class="pin-container">
        <span id="generatedPin" class="pin-display"></span>
        <button id="copyPinBtn" class="copy-btn" title="Copiar PIN">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path
              d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
            ></path>
          </svg>
        </button>
      </div>
      <div id="copyStatus" class="copy-status"></div>
    </div>
    <div class="modal-footer">
      <button id="closeModalBtn" class="btn-primary">Continuar</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");
    const modal = document.getElementById("pinModal");
    const pinDisplay = document.getElementById("generatedPin");
    const copyBtn = document.getElementById("copyPinBtn");
    const copyStatus = document.getElementById("copyStatus");
    const closeBtn = document.getElementById("closeModalBtn");

    // Solo manejar envío del formulario de registro con AJAX
    if ("{{ form_type }}" === "register") {
      form.addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(form);

        // Mostrar indicador de carga
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = "Creando cuenta...";
        submitBtn.disabled = true;

        fetch('{{ url_for("auth.register") }}', {
          method: "POST",
          body: formData,
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        })
          .then((response) => {
            console.log("Response status:", response.status);
            console.log("Response headers:", response.headers);
            return response.json();
          })
          .then((data) => {
            console.log("Response data:", data);
            if (data.success) {
              pinDisplay.textContent = data.pin;
              modal.style.display = "block";
            } else {
              // Mostrar errores de validación si existen
              if (data.errors) {
                let errorMessage = data.message + "\n\n";
                for (const [field, error] of Object.entries(data.errors)) {
                  errorMessage += `• ${field}: ${error}\n`;
                }
                alert(errorMessage);
              } else {
                alert(data.message || "Error desconocido");
              }
            }
          })
          .catch((error) => {
            console.error("Error completo:", error);
            alert("Error al procesar el registro: " + error.message);
          })
          .finally(() => {
            // Restaurar botón
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          });
      });

      // Copiar PIN al portapapeles
      copyBtn.addEventListener("click", function () {
        const pin = pinDisplay.textContent;
        navigator.clipboard
          .writeText(pin)
          .then(function () {
            copyStatus.textContent = "PIN copiado al portapapeles";
            copyStatus.style.color = "#28a745";
            setTimeout(() => {
              copyStatus.textContent = "";
            }, 2000);
          })
          .catch(function () {
            copyStatus.textContent = "Error al copiar";
            copyStatus.style.color = "#dc3545";
          });
      });

      // Cerrar modal
      closeBtn.addEventListener("click", function () {
        modal.style.display = "none";
        window.location.href = '{{ url_for("auth.login") }}';
      });

      // Cerrar modal al hacer clic fuera de él
      modal.addEventListener("click", function (e) {
        if (e.target === modal) {
          modal.style.display = "none";
          window.location.href = '{{ url_for("auth.login") }}';
        }
      });
    }
  });
</script>
{% endblock %}
