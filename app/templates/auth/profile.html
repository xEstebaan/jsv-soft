{% extends "base.html" %} {% block title %}Mi Perfil{% endblock %} {% block
stylesheets %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/profile.css') }}"
/>
{% endblock %} {% block content %}
<div class="profile-page">
  <!-- Header Section -->
  <div class="profile-header">
    <h1 class="user-name">
      {{ persona.primer_nombre }} {{ persona.primer_apellido }}
    </h1>
    <p class="user-email">{{ persona.correo }}</p>
  </div>

  <!-- Main Content Card -->
  <div class="profile-card">
    <!-- Navigation Tabs -->
    <div class="tab-navigation">
      <button class="tab-button active" data-tab="personal-data">
        Datos personales
      </button>
      <button class="tab-button" data-tab="password-management">
        Gestionar contraseña
      </button>
      <button class="tab-button" data-tab="access-pin">PIN de acceso</button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Personal Data Tab -->
      <div id="personal-data" class="tab-panel active">
        <div class="data-list">
          <div class="data-item">
            <span class="data-label">Nombre completo</span>
            <span class="data-value"
              >{{ persona.primer_nombre }} {{ persona.segundo_nombre or '' }} {{
              persona.primer_apellido }} {{ persona.segundo_apellido or ''
              }}</span
            >
          </div>
          <div class="data-item">
            <span class="data-label">Email</span>
            <span class="data-value">{{ persona.correo }}</span>
          </div>
          <div class="data-item">
            <span class="data-label">Cargo</span>
            <span class="data-value"
              >{{ empleado.cargo.nombre if empleado and empleado.cargo else 'No
              especificado' }}</span
            >
          </div>
          <div class="data-item">
            <span class="data-label">Fecha de registro</span>
            <span class="data-value"
              >{{ persona.fecha_creacion.strftime('%d de %B de %Y') if
              persona.fecha_creacion else 'No disponible' }}</span
            >
          </div>
          <div class="data-item">
            <span class="data-label">Estado</span>
            <span class="data-value status-active">Activo</span>
          </div>
        </div>
      </div>

      <!-- Password Management Tab -->
      <div id="password-management" class="tab-panel">
        <div class="password-form-container">
          <form id="password-form" class="password-form">
            <div class="form-group">
              <label for="current-password">Contraseña Actual</label>
              <input
                type="password"
                id="current-password"
                name="current-password"
                class="form-control"
                required
              />
            </div>

            <div class="form-group">
              <label for="new-password">Nueva Contraseña</label>
              <input
                type="password"
                id="new-password"
                name="new-password"
                class="form-control"
                required
                minlength="6"
              />
            </div>

            <div class="form-group">
              <label for="confirm-password">Confirmar Nueva Contraseña</label>
              <input
                type="password"
                id="confirm-password"
                name="confirm-password"
                class="form-control"
                required
                minlength="6"
              />
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                Cambiar Contraseña
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Access PIN Tab -->
      <div id="access-pin" class="tab-panel">
        <div class="pin-container">
          <div class="pin-display">
            <span id="pin-value" class="pin-hidden">•••••••</span>
            <span id="pin-actual" style="display: none">{{ pin }}</span>
          </div>
          <button class="btn btn-secondary" onclick="togglePinVisibility()">
            <span id="pin-toggle-text">Mostrar PIN</span>
          </button>
          <p class="pin-info">
            Tu PIN de acceso es único y se genera automáticamente. Úsalo para
            acceder a funciones especiales del sistema.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab functionality
    document.addEventListener("DOMContentLoaded", function () {
      const tabButtons = document.querySelectorAll(".tab-button");
      const tabPanels = document.querySelectorAll(".tab-panel");

      tabButtons.forEach((button) => {
        button.addEventListener("click", function () {
          const targetTab = this.getAttribute("data-tab");

          // Remove active class from all buttons and panels
          tabButtons.forEach((btn) => btn.classList.remove("active"));
          tabPanels.forEach((panel) => panel.classList.remove("active"));

          // Add active class to clicked button and corresponding panel
          this.classList.add("active");
          document.getElementById(targetTab).classList.add("active");
        });
      });
    });

    // PIN visibility toggle
    let isPinVisible = false;

    function togglePinVisibility() {
      isPinVisible = !isPinVisible;

      if (isPinVisible) {
        document.getElementById("pin-value").style.display = "none";
        document.getElementById("pin-actual").style.display = "inline";
        document.getElementById("pin-toggle-text").textContent = "Ocultar PIN";
      } else {
        document.getElementById("pin-value").style.display = "inline";
        document.getElementById("pin-actual").style.display = "none";
        document.getElementById("pin-toggle-text").textContent = "Mostrar PIN";
      }
    }

    // Password form handling
    document
      .getElementById("password-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const currentPassword =
          document.getElementById("current-password").value;
        const newPassword = document.getElementById("new-password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;

        if (newPassword !== confirmPassword) {
          alert("Las contraseñas nuevas no coinciden");
          return;
        }

        if (newPassword.length < 6) {
          alert("La nueva contraseña debe tener al menos 6 caracteres");
          return;
        }

        // Send data to server
        const formData = {
          current_password: currentPassword,
          new_password: newPassword,
          confirm_password: confirmPassword,
        };

        fetch('{{ url_for("profile.change_password") }}', {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
          body: JSON.stringify(formData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Contraseña actualizada correctamente");
              this.reset();
            } else {
              alert("Error: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error al cambiar la contraseña");
          });
      });
  </script>
  {% endblock %}
</div>
