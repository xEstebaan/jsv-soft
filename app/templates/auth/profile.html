{% extends "base.html" %} {% block title %}Mi Perfil{% endblock %} {% block
header_buttons %}
<a href="{{ url_for('auth.logout') }}" class="nav-button nav-button--secondary"
  >Salir</a
>
{% endblock %} {% block stylesheets %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/profile.css') }}"
/>
{% endblock %} {% block content %}
<div class="profile-page">
  <!-- Header Section -->
  <div class="profile-header">
    <h1 class="user-name">
      {{ persona.primer_nombre }} {{ persona.primer_apellido }}
    </h1>
    <p class="user-email">{{ persona.correo }}</p>
  </div>

  <!-- Main Content Card -->
  <div class="profile-card">
    <!-- Navigation Tabs -->
    <div class="tab-navigation">
      <button class="tab-button active" data-tab="personal-data">
        Datos personales
      </button>
      <button class="tab-button" data-tab="password-management">
        Gestionar contraseña
      </button>
      <button class="tab-button" data-tab="access-pin">PIN de acceso</button>
      <button class="tab-button" data-tab="history">Historial</button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Personal Data Tab -->
      <div id="personal-data" class="tab-panel active">
        <div class="data-list">
          <div class="data-item">
            <span class="data-label">Nombre completo</span>
            <span class="data-value"
              >{{ persona.primer_nombre }} {{ persona.segundo_nombre or '' }} {{
              persona.primer_apellido }} {{ persona.segundo_apellido or ''
              }}</span
            >
          </div>
          <div class="data-item">
            <span class="data-label">Email</span>
            <span class="data-value">{{ persona.correo }}</span>
          </div>
          <div class="data-item">
            <span class="data-label">Cargo</span>
            <span class="data-value"
              >{{ empleado.cargo.descripcion if empleado and empleado.cargo else
              'No especificado' }}</span
            >
          </div>
          <div class="data-item">
            <span class="data-label">Fecha de registro</span>
            <span class="data-value"
              >{{ persona.fecha_creacion | fecha_es }}</span
            >
          </div>
          <div class="data-item">
            <span class="data-label">Estado</span>
            <span class="data-value status-active">Activo</span>
          </div>
        </div>
      </div>

      <!-- Password Management Tab -->
      <div id="password-management" class="tab-panel">
        <div class="password-form-container">
          <form id="password-form" class="password-form">
            <div class="form-group">
              <label for="current-password">Contraseña Actual</label>
              <input
                type="password"
                id="current-password"
                name="current-password"
                class="form-control"
                required
              />
            </div>

            <div class="form-group">
              <label for="new-password">Nueva Contraseña</label>
              <input
                type="password"
                id="new-password"
                name="new-password"
                class="form-control"
                required
                minlength="6"
              />
            </div>

            <div class="form-group">
              <label for="confirm-password">Confirmar Nueva Contraseña</label>
              <input
                type="password"
                id="confirm-password"
                name="confirm-password"
                class="form-control"
                required
                minlength="6"
              />
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                Cambiar Contraseña
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Access PIN Tab -->
      <div id="access-pin" class="tab-panel">
        <div class="pin-container">
          <div class="pin-display">
            <span id="pin-value" class="pin-hidden">•••••••</span>
            <span id="pin-actual" style="display: none">{{ pin }}</span>
          </div>
          <button class="btn btn-secondary" onclick="togglePinVisibility()">
            <span id="pin-toggle-text">Mostrar PIN</span>
          </button>
          <p class="pin-info">
            Tu PIN de acceso es único y se genera automáticamente. Úsalo para
            acceder a funciones especiales del sistema.
          </p>
        </div>
      </div>

      <!-- History Tab -->
      <div id="history" class="tab-panel">
        <div class="history-container">
          <div class="history-header">
            <h3>Historial de Registros</h3>
            <div class="week-filter">
              <label for="week-selector">Selecciona la semana:</label>
              <input type="week" id="week-selector" class="week-input" />
            </div>
          </div>

          <div class="history-table-container">
            <table class="history-table">
              <thead>
                <tr>
                  <th>NOMBRE DE USUARIO</th>
                  <th>FECHA</th>
                  <th>HORA DE ENTRADA</th>
                  <th>HORA DE SALIDA</th>
                </tr>
              </thead>
              <tbody id="history-tbody">
                <tr>
                  <td colspan="4" class="no-data">
                    Selecciona una semana para ver el historial
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab functionality
    document.addEventListener("DOMContentLoaded", function () {
      const tabButtons = document.querySelectorAll(".tab-button");
      const tabPanels = document.querySelectorAll(".tab-panel");

      tabButtons.forEach((button) => {
        button.addEventListener("click", function () {
          const targetTab = this.getAttribute("data-tab");

          // Remove active class from all buttons and panels
          tabButtons.forEach((btn) => btn.classList.remove("active"));
          tabPanels.forEach((panel) => panel.classList.remove("active"));

          // Add active class to clicked button and corresponding panel
          this.classList.add("active");
          document.getElementById(targetTab).classList.add("active");
        });
      });
    });

    // PIN visibility toggle
    let isPinVisible = false;

    function togglePinVisibility() {
      isPinVisible = !isPinVisible;

      if (isPinVisible) {
        document.getElementById("pin-value").style.display = "none";
        document.getElementById("pin-actual").style.display = "inline";
        document.getElementById("pin-toggle-text").textContent = "Ocultar PIN";
      } else {
        document.getElementById("pin-value").style.display = "inline";
        document.getElementById("pin-actual").style.display = "none";
        document.getElementById("pin-toggle-text").textContent = "Mostrar PIN";
      }
    }

    // Password form handling
    document
      .getElementById("password-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const currentPassword =
          document.getElementById("current-password").value;
        const newPassword = document.getElementById("new-password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;

        if (newPassword !== confirmPassword) {
          alert("Las contraseñas nuevas no coinciden");
          return;
        }

        if (newPassword.length < 6) {
          alert("La nueva contraseña debe tener al menos 6 caracteres");
          return;
        }

        // Send data to server
        const formData = {
          current_password: currentPassword,
          new_password: newPassword,
          confirm_password: confirmPassword,
        };

        fetch('{{ url_for("profile.change_password") }}', {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
          body: JSON.stringify(formData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Contraseña actualizada correctamente");
              this.reset();
            } else {
              alert("Error: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error al cambiar la contraseña");
          });
      });

    // History functionality
    const weekSelector = document.getElementById("week-selector");
    const historyTbody = document.getElementById("history-tbody");

    // Set default week to current week
    const today = new Date();
    const currentWeek = getWeekString(today);
    weekSelector.value = currentWeek;

    weekSelector.addEventListener("change", function () {
      const selectedWeek = this.value;
      if (selectedWeek) {
        loadHistoryData(selectedWeek);
      }
    });

    function getWeekString(date) {
      const year = date.getFullYear();
      const week = getWeekNumber(date);
      return `${year}-W${week.toString().padStart(2, "0")}`;
    }

    function getWeekNumber(date) {
      const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
      const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
      return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    }

    function loadHistoryData(weekString) {
      // Show loading state
      historyTbody.innerHTML =
        '<tr><td colspan="4" class="loading">Cargando datos...</td></tr>';

      console.log("Cargando historial para semana:", weekString);

      fetch(`{{ url_for('profile.get_history') }}?week=${weekString}`)
        .then((response) => {
          console.log("Respuesta del servidor:", response.status);
          return response.json();
        })
        .then((data) => {
          console.log("Datos recibidos:", data);
          if (data.success) {
            console.log("Número de registros:", data.registros.length);
            displayHistoryData(data.registros);
          } else {
            console.error("Error del servidor:", data.message);
            historyTbody.innerHTML =
              '<tr><td colspan="4" class="error">Error al cargar los datos: ' +
              data.message +
              "</td></tr>";
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          historyTbody.innerHTML =
            '<tr><td colspan="4" class="error">Error al cargar los datos</td></tr>';
        });
    }

    function displayHistoryData(registros) {
      console.log("Mostrando registros:", registros);

      if (registros.length === 0) {
        console.log("No hay registros para mostrar");
        historyTbody.innerHTML =
          '<tr><td colspan="4" class="no-data">No hay registros para esta semana</td></tr>';
        return;
      }

      // Group registros by date and create pairs of entrada/salida
      const groupedRegistros = {};
      registros.forEach((registro) => {
        console.log("Procesando registro:", registro);
        const fecha = registro.fecha_hora.split("T")[0];
        if (!groupedRegistros[fecha]) {
          groupedRegistros[fecha] = [];
        }

        // Add the registro to the date array
        groupedRegistros[fecha].push(registro);
      });

      // Sort registros by time within each date
      Object.keys(groupedRegistros).forEach((fecha) => {
        groupedRegistros[fecha].sort(
          (a, b) => new Date(a.fecha_hora) - new Date(b.fecha_hora)
        );
      });

      console.log("Registros agrupados:", groupedRegistros);

      // Create table rows - show each entrada/salida pair as a separate row
      let html = "";
      Object.keys(groupedRegistros)
        .sort()
        .forEach((fecha) => {
          const registrosDelDia = groupedRegistros[fecha];
          const fechaFormatted = new Date(fecha).toLocaleDateString("es-ES");

          // Process registros in pairs
          for (let i = 0; i < registrosDelDia.length; i += 2) {
            const entrada = registrosDelDia[i];
            const salida = registrosDelDia[i + 1];

            const horaEntrada = entrada
              ? new Date(entrada.fecha_hora).toLocaleTimeString("es-ES", {
                  hour: "2-digit",
                  minute: "2-digit",
                })
              : "-";
            const horaSalida = salida
              ? new Date(salida.fecha_hora).toLocaleTimeString("es-ES", {
                  hour: "2-digit",
                  minute: "2-digit",
                })
              : "-";

            html += `
            <tr>
              <td>{{ persona.primer_nombre }} {{ persona.primer_apellido }}</td>
              <td>${fechaFormatted}</td>
              <td>${horaEntrada}</td>
              <td>${horaSalida}</td>
            </tr>
          `;
          }
        });

      historyTbody.innerHTML = html;
    }
  </script>
  {% endblock %}
</div>
